<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="mobile-web-app-capable" content="yes">
</head>

<body>

    <style type="text/css">
        .drag {
            width: 98px;
            height: 100px;
            line-height: 100px;
            border: 1px solid black;
            cursor: pointer;
            border-radius: 10px;
            text-align: center;
            background-color: lightpink;
            position: relative;
            left: 0px;
            top: 50px;
        }

        .container {
            background-color: lightblue;
            width: 100px;
            height: 200px;
            border: 1px solid black;
            float: left;
        }

        #container-right {
            float: right;
        }

        #text-container {
            clear: both;
            text-align: center;
        }
    </style>

    <br>

    <div id="not-connected">Not connected. Retry?</div>

    <div id="container-left" class="container">
        <div id="left" class="drag" style="left:0px;top:50px;">drag me</div>
    </div>

    <div id="container-right" class="container">
        <div id="right" class="drag" style="left:0px;top:50px;">drag me</div>
    </div>

    <div id="text-container">
        <form id="send-text">
            <input type="text" id="send-text-text" placeholder="text to display" />
            <input type="submit" value="send" />
        </form>
        <button class="display-face">smile</button>
        <button class="display-face">sad</button>
        <button class="display-face">neutral</button>
    </div>

    <script type="text/javascript" src="/static/jquery.min.js"></script>
    <script type="text/javascript" src="/static/jquery-ui.min.js"></script>
    <script type="text/javascript" src="/static/jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="/static/communication-handler.js"></script>
    <script>

        $('#send-text').submit(function (e) {
            var val = $('#send-text-text').val();
            if (val) {
                communication.send('text', val);
            }
            e.preventDefault();
        })

        $('.display-face').click(function () {
            communication.send('face', this.innerHTML);
        });

        var state = (function () {
            var internal = {};

            return {
                getState: function (identifier) {
                    return internal[identifier];
                },
                setState: function (identifier, value) {
                    if (internal[identifier] !== value) {
                        internal[identifier] = value;
                        communication.send(identifier, value);
                    }
                }
            }
        }());

        var revert = function (event, ui) {
            var $this = $(this);
            $this.data("uiDraggable").originalPosition = {
                top: 50,
                left: 0
            };
            state.setState($this.attr('id'), "stop");
            return true;
        };

        var drag = function (event, ui) {
            var $this = $(this);
            var thisPos = $this.position();
            var parentPos = $this.parent().position();

            var y = thisPos.top - parentPos.top;

            if (y < 50) {
                state.setState(this.id, "up");
            } else {
                state.setState(this.id, "down");
            }
        }

        $("#left").draggable({
            containment: "#container-left",
            revert: revert,
            drag: drag
        });

        $("#right").draggable({
            containment: "#container-right",
            revert: revert,
            drag: drag
        });

        var errorBlock = document.getElementById("not-connected");

        errorBlock.onclick = function () {
            communication.connect();
        };

        var path = `${location.protocol === 'https:' ? 'wss' : 'ws'}:\/\/${location.host + location.pathname}ws`;

        var handler = function (message) {
            console.log(message);
        };

        var communication = communicationHandler(path, errorBlock, handler);

        $(function () {
            communication.connect()
        });

    </script>
</body>

</html>